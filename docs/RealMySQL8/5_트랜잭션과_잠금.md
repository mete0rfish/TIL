# 5.1 트랜잭션
트랜잭션을 지원하는 InnoDB의 처리 방식 차이를 살펴보고자 한다.
또한, 트랜잭션 사용 시 주의사항도 함께 알아보자.

## 5.1.1 MySQL에서의 트랜잭션
트랜잭션은 쿼리 개수 상관없이 논리적인 작업 셋이 100% 적용되거나 적용되지 않아야함을 보장해주는 단위.
InnoDB는 쿼리 중 일부라도 오류가 발생하면 전체를 원 상태로 만든다는 원칙.

## 5.1.2 주의사항
트랜잭션 또한 DBMS의 커넥션과 동일하게 꼭 필요한 최소의 코드에만 적용하는 것이 좋다.
즉, 프로그램 코드에서 트랜잭션 범위를 최소화하라는 의미다.

예를 들어, 아래 처럼 많은 과정을 트랜잭션으로 처리하게 되면 어떤 문제가 발생할까?
**[잘못된 트랜잭션 설정]**
```
1) 처리 시작
    => 데이터베이스 커넥션 생성
    => 트랜잭션 시작
2) 사용자의 로그인 여부 확인
3) 사용자의 글쓰기 내용의 오류 여부 확인
4) 첨부로 업로드된 파일 확인 및 저장
5) 사용자의 입력 내용을 DBMS에 저장
6) 첨부 파일 정보를 DBMS에 저장
7) 저장된 내용 또는 기타 정보를 DBMS에서 조회
8) 게시물 등록에 대한 알림 메일 발송
9) 알림 메일 발송 이력을 DBMS에 저장
    <= 트랜잭션 종료(COMMIT)
    <= 데이터베이스 커넥션 반납
10) 처리 완료
```
- 데이터베이스 커넥션을 1, 2번 사이에 생성하면, 커넥션 풀이 그만큼 부족 상태로 발생한다.
- 8번 적업은 외부 네트워크 I/O가 발생하기 때문에 트랜잭션에서 빼는 것이 좋다. 만약 네트워크 접속이 안되면, DB에도 영향을 미친다.
- DBMS 작업이 크게 4개가 있다. 5,6 번은 하나의 트랜잭션으로 묶어야 하며, 7번 작업은 저장된 데이터 단순 확인 및 조회이므로 트랜잭션에 포함할 필요 없음.

**[수정된 트랜잭션]**
```
1) 처리 시작
2) 사용자의 로그인 여부 확인
3) 사용자의 글쓰기 내용의 오류 여부 확인
4) 첨부로 업로드된 파일 확인 및 저장
    => 데이터베이스 커넥션 생성
    => 트랜잭션 시작
5) 사용자의 입력 내용을 DBMS에 저장
6) 첨부 파일 정보를 DBMS에 저장
    <= 트랜잭션 종료(COMMIT)
7) 저장된 내용 또는 기타 정보를 DBMS에서 조회
8) 게시물 등록에 대한 알림 메일 발송
    => 트랜잭션 시작
9) 알림 메일 발송 이력을 DBMS에 저장
    <= 트랜잭션 종료(COMMIT)
    <= 데이터베이스 커넥션 반납
10) 처리 완료
```

# 5.2 MySQL 엔진의 잠금
MySQL에서 사용되는 잠금은 크게 스토리지 엔진 레벨과 MySQL 엔진 레벨로 나눌 수 있다.
- MySQL 엔진 레벨 잠금
    - 모든 스토리지 엔진에 영향 미침
    - 메타데이터 락, 네임드 락 제공
- 스토리지 엔진 레벨의 잠금
    - 스토리지 엔진 간 상호 영향을 미치지 않음
  
