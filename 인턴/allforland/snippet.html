<!DOCTYPE html>
<html>
<head>
    <title>GeoServer WFS í´ëŸ¬ìŠ¤í„°ë§ ì§€ë„</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.1.0/ol.css">
    <style>
        body { font-family: sans-serif; }
        #map { width: 100%; height: 600px; }
        #controls { margin-bottom: 8px; }
        #controls label { margin-right: 15px; }
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 300px;
            max-height: 250px;
            overflow-y: auto;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%; border: solid transparent; content: " "; height: 0; width: 0;
            position: absolute; pointer-events: none;
        }
        .ol-popup:after { border-top-color: white; border-width: 10px; left: 48px; margin-left: -10px; }
        .ol-popup:before { border-top-color: #cccccc; border-width: 11px; left: 48px; margin-left: -11px; }
        .ol-popup-closer { text-decoration: none; position: absolute; top: 2px; right: 8px; }
        .ol-popup-closer:after { content: "âœ–"; }
        #popup-content ul { padding-left: 15px; }
        #popup-content h5 { margin-top: 10px; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
    </style>
</head>
<body>
    <h2>êµ­ê°€ ì§€ì • ìœ ì‚° ì§€ë„ (í´ëŸ¬ìŠ¤í„°ë§)</h2>

    <div id="controls">
        <input type="checkbox" id="layer-toggle" checked>
        <label for="layer-toggle">êµ­ê°€ì§€ì •ìœ ì‚° ë ˆì´ì–´ ë³´ê¸°</label>

        <input type="checkbox" id="basemap-toggle" checked>
        <label for="basemap-toggle">ë°°ê²½ ì§€ë„ ë³´ê¸°</label>
    </div>

    <div id="map"></div>

    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v9.1.0/dist/ol.js"></script>
    <script>
        // --- íŒì—… ê´€ë ¨ ìš”ì†Œ ì„¤ì • (ê¸°ì¡´ê³¼ ë™ì¼) ---
        const container = document.getElementById('popup');
        const content = document.getElementById('popup-content');
        const closer = document.getElementById('popup-closer');

        const overlay = new ol.Overlay({
            element: container,
            autoPan: {
                animation: { duration: 250 },
            },
        });

        closer.onclick = function () {
            overlay.setPosition(undefined);
            closer.blur();
            return false;
        };

        // --- â¬‡ï¸ 1. ë°ì´í„° ì†ŒìŠ¤ ë³€ê²½: WMS -> WFS â¬‡ï¸ ---
        // GeoServer WFSë¥¼ í†µí•´ ì›ë³¸ ë²¡í„° ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const wfsSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: function(extent) {
                return `http://localhost:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=test:êµ­ê°€ì§€ì •ìœ ì‚°&outputFormat=application/json&srsname=EPSG:3857&bbox=${extent.join(',')},EPSG:3857`;
            },
            strategy: ol.loadingstrategy.bbox
        });
        
        // --- â¬‡ï¸ 2. í´ëŸ¬ìŠ¤í„° ì†ŒìŠ¤ ì¶”ê°€ â¬‡ï¸ ---
        // ê°€ì ¸ì˜¨ WFS ë²¡í„° ì†ŒìŠ¤ë¥¼ í´ëŸ¬ìŠ¤í„° ì†ŒìŠ¤ë¡œ ê°ìŒ‰ë‹ˆë‹¤.
        const clusterSource = new ol.source.Cluster({
            distance: 50, // í´ëŸ¬ìŠ¤í„°ë§ë  í”½ì…€ ê±°ë¦¬ (ê°’ì´ í´ìˆ˜ë¡ ë” ë©€ë¦¬ ìˆëŠ” ì•„ì´ì½˜ë„ í•©ì³ì§)
            minDistance: 20, // ìµœì†Œ í´ëŸ¬ìŠ¤í„°ë§ í”½ì…€ ê±°ë¦¬
            source: wfsSource, // ì›ë³¸ ì†ŒìŠ¤ë¥¼ WFS ì†ŒìŠ¤ë¡œ ì§€ì •
        });

        // --- â¬‡ï¸ 3. ìŠ¤íƒ€ì¼ ì •ì˜ â¬‡ï¸ ---
        // ìŠ¤íƒ€ì¼ ìºì‹œ: ë™ì¼í•œ í¬ê¸°ì˜ í´ëŸ¬ìŠ¤í„° ìŠ¤íƒ€ì¼ì„ ë°˜ë³µ ìƒì„±í•˜ì§€ ì•Šê¸° ìœ„í•¨
        const styleCache = {};
        const clusterStyle = function(feature) {
            const size = feature.get('features').length;
            let style = styleCache[size];
            if (!style) {
                if (size > 1) {
                    // 2ê°œ ì´ìƒ ë¬¶ì¸ í´ëŸ¬ìŠ¤í„° ìŠ¤íƒ€ì¼
                    style = new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 10 + size / 5, // ê°œìˆ˜ì— ë”°ë¼ ì› í¬ê¸° ì¡°ì ˆ
                            fill: new ol.style.Fill({
                                color: 'rgba(51, 153, 204, 0.8)',
                            }),
                            stroke: new ol.style.Stroke({ color: '#fff', width: 1 })
                        }),
                        text: new ol.style.Text({
                            text: size.toString(),
                            fill: new ol.style.Fill({
                                color: '#fff',
                            }),
                            font: '12px sans-serif'
                        }),
                    });
                } else {
                    // 1ê°œì§œë¦¬ ê°œë³„ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ (í´ëŸ¬ìŠ¤í„° ì•„ë‹˜)
                    style = new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 6,
                            fill: new ol.style.Fill({
                                color: 'rgba(255, 102, 102, 0.9)',
                            }),
                            stroke: new ol.style.Stroke({ color: '#fff', width: 1.5 })
                        })
                        // ğŸ’¡ ì•„ì´ì½˜ ì´ë¯¸ì§€ ì‚¬ìš© ì˜ˆì‹œ
                        // image: new ol.style.Icon({
                        //   anchor: [0.5, 46],
                        //   anchorXUnits: 'fraction',
                        //   anchorYUnits: 'pixels',
                        //   src: 'path/to/your/icon.png' 
                        // })
                    });
                }
                styleCache[size] = style;
            }
            return style;
        };
        
        // --- â¬‡ï¸ 4. ë ˆì´ì–´ ë³€ê²½: WMS ë ˆì´ì–´ -> í´ëŸ¬ìŠ¤í„° ë²¡í„° ë ˆì´ì–´ â¬‡ï¸ ---
        const clusterLayer = new ol.layer.Vector({
            source: clusterSource,
            style: clusterStyle // ìœ„ì—ì„œ ì •ì˜í•œ ìŠ¤íƒ€ì¼ í•¨ìˆ˜ ì ìš©
        });

        // ë°°ê²½ ì§€ë„ (ê¸°ì¡´ê³¼ ë™ì¼)
        const baseMap = new ol.layer.Tile({
            source: new ol.source.OSM()
        });
        
        // ëŒ€í•œë¯¼êµ­ ì˜ì—­ ì •ì˜ (ê¸°ì¡´ê³¼ ë™ì¼)
        const koreaExtent4326 = [124.5, 33.0, 132.0, 38.8];
        const koreaExtent3857 = ol.proj.transformExtent(koreaExtent4326, 'EPSG:4326', 'EPSG:3857');

        // ì§€ë„ ê°ì²´ ìƒì„±
        const map = new ol.Map({
            target: 'map',
            layers: [baseMap, clusterLayer], // â—€â—€â—€ wmsLayer ëŒ€ì‹  clusterLayerë¡œ ë³€ê²½
            overlays: [overlay],
            view: new ol.View({
                center: ol.proj.fromLonLat([127.9, 36.5]),
                zoom: 7.5,
                extent: koreaExtent3857,
                minZoom: 7
            })
        });

        // ë ˆì´ì–´ í† ê¸€ ê¸°ëŠ¥
        const layerToggleCheckbox = document.getElementById('layer-toggle');
        layerToggleCheckbox.addEventListener('change', function() {
            clusterLayer.setVisible(this.checked); // â—€â—€â—€ clusterLayerë¡œ ë³€ê²½
        });

        // ë°°ê²½ ì§€ë„ í† ê¸€ ê¸°ëŠ¥ (ê¸°ì¡´ê³¼ ë™ì¼)
        const basemapToggleCheckbox = document.getElementById('basemap-toggle');
        basemapToggleCheckbox.addEventListener('change', function() {
            baseMap.setVisible(this.checked);
        });

        // --- â¬‡ï¸ 5. íŒì—… ë¡œì§ ìˆ˜ì • â¬‡ï¸ ---
        map.on('singleclick', function (evt) {
            // í´ë¦­í•œ ìœ„ì¹˜ì— ìˆëŠ” í”¼ì²˜(ì•„ì´ì½˜)ë¥¼ ì°¾ìŒ
            const feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                return feature;
            });
            
            overlay.setPosition(undefined); // ì´ì „ íŒì—… ë‹«ê¸°

            if (feature) {
                const coordinate = evt.coordinate;
                const originalFeatures = feature.get('features');
                const featureCount = originalFeatures.length;

                if (featureCount > 1) { // í´ëŸ¬ìŠ¤í„°ë¥¼ í´ë¦­í•œ ê²½ìš°
                    let contentHtml = `<h4>${featureCount}ê°œì˜ ìœ ì‚° ì •ë³´</h4>`;
                    
                    originalFeatures.forEach(function(f, i) {
                        const props = f.getProperties();
                        // ğŸ’¡ ì—¬ê¸°ì„œ 'l_kor_nm'ì€ ì‹¤ì œ ë°ì´í„°ì˜ ë¬¸í™”ìœ ì‚° ì´ë¦„ ì»¬ëŸ¼ëª…ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
                        contentHtml += `<h5>${i + 1}. ${props.l_kor_nm || 'ì´ë¦„ ì—†ìŒ'}</h5>`;
                    });

                    content.innerHTML = contentHtml;
                    overlay.setPosition(coordinate);

                } else if (featureCount === 1) { // ê°œë³„ ì•„ì´ì½˜ì„ í´ë¦­í•œ ê²½ìš°
                    const properties = originalFeatures[0].getProperties();
                    
                    let contentHtml = `<h4>ì†ì„± ì •ë³´</h4><ul>`;
                    for (const key in properties) {
                        // geometry ì •ë³´ëŠ” íŒì—…ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
                        if (key !== 'geometry') {
                            contentHtml += `<li><b>${key}:</b> ${properties[key]}</li>`;
                        }
                    }
                    contentHtml += '</ul>';

                    content.innerHTML = contentHtml;
                    overlay.setPosition(coordinate);
                }
            }
        });
    </script>
</body>
</html>