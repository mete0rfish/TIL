<!DOCTYPE html>
<html>
<head>
    <title>GeoServer WFS 클러스터링 지도</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.1.0/ol.css">
    <style>
        body { font-family: sans-serif; }
        #map { width: 100%; height: 600px; }
        #controls { margin-bottom: 8px; }
        #controls label { margin-right: 15px; }
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 300px;
            max-height: 250px;
            overflow-y: auto;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%; border: solid transparent; content: " "; height: 0; width: 0;
            position: absolute; pointer-events: none;
        }
        .ol-popup:after { border-top-color: white; border-width: 10px; left: 48px; margin-left: -10px; }
        .ol-popup:before { border-top-color: #cccccc; border-width: 11px; left: 48px; margin-left: -11px; }
        .ol-popup-closer { text-decoration: none; position: absolute; top: 2px; right: 8px; }
        .ol-popup-closer:after { content: "✖"; }
        #popup-content ul { padding-left: 15px; }
        #popup-content h5 { margin-top: 10px; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
    </style>
</head>
<body>
    <h2>국가 지정 유산 지도 (클러스터링)</h2>

    <div id="controls">
        <input type="checkbox" id="layer-toggle" checked>
        <label for="layer-toggle">국가지정유산 레이어 보기</label>

        <input type="checkbox" id="basemap-toggle" checked>
        <label for="basemap-toggle">배경 지도 보기</label>
    </div>

    <div id="map"></div>

    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v9.1.0/dist/ol.js"></script>
    <script>
        // --- 팝업 관련 요소 설정 (기존과 동일) ---
        const container = document.getElementById('popup');
        const content = document.getElementById('popup-content');
        const closer = document.getElementById('popup-closer');

        const overlay = new ol.Overlay({
            element: container,
            autoPan: {
                animation: { duration: 250 },
            },
        });

        closer.onclick = function () {
            overlay.setPosition(undefined);
            closer.blur();
            return false;
        };

        // --- ⬇️ 1. 데이터 소스 변경: WMS -> WFS ⬇️ ---
        // GeoServer WFS를 통해 원본 벡터 데이터를 가져옵니다.
        const wfsSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: function(extent) {
                return `http://localhost:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=test:국가지정유산&outputFormat=application/json&srsname=EPSG:3857&bbox=${extent.join(',')},EPSG:3857`;
            },
            strategy: ol.loadingstrategy.bbox
        });
        
        // --- ⬇️ 2. 클러스터 소스 추가 ⬇️ ---
        // 가져온 WFS 벡터 소스를 클러스터 소스로 감쌉니다.
        const clusterSource = new ol.source.Cluster({
            distance: 50, // 클러스터링될 픽셀 거리 (값이 클수록 더 멀리 있는 아이콘도 합쳐짐)
            minDistance: 20, // 최소 클러스터링 픽셀 거리
            source: wfsSource, // 원본 소스를 WFS 소스로 지정
        });

        // --- ⬇️ 3. 스타일 정의 ⬇️ ---
        // 스타일 캐시: 동일한 크기의 클러스터 스타일을 반복 생성하지 않기 위함
        const styleCache = {};
        const clusterStyle = function(feature) {
            const size = feature.get('features').length;
            let style = styleCache[size];
            if (!style) {
                if (size > 1) {
                    // 2개 이상 묶인 클러스터 스타일
                    style = new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 10 + size / 5, // 개수에 따라 원 크기 조절
                            fill: new ol.style.Fill({
                                color: 'rgba(51, 153, 204, 0.8)',
                            }),
                            stroke: new ol.style.Stroke({ color: '#fff', width: 1 })
                        }),
                        text: new ol.style.Text({
                            text: size.toString(),
                            fill: new ol.style.Fill({
                                color: '#fff',
                            }),
                            font: '12px sans-serif'
                        }),
                    });
                } else {
                    // 1개짜리 개별 아이콘 스타일 (클러스터 아님)
                    style = new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 6,
                            fill: new ol.style.Fill({
                                color: 'rgba(255, 102, 102, 0.9)',
                            }),
                            stroke: new ol.style.Stroke({ color: '#fff', width: 1.5 })
                        })
                        // 💡 아이콘 이미지 사용 예시
                        // image: new ol.style.Icon({
                        //   anchor: [0.5, 46],
                        //   anchorXUnits: 'fraction',
                        //   anchorYUnits: 'pixels',
                        //   src: 'path/to/your/icon.png' 
                        // })
                    });
                }
                styleCache[size] = style;
            }
            return style;
        };
        
        // --- ⬇️ 4. 레이어 변경: WMS 레이어 -> 클러스터 벡터 레이어 ⬇️ ---
        const clusterLayer = new ol.layer.Vector({
            source: clusterSource,
            style: clusterStyle // 위에서 정의한 스타일 함수 적용
        });

        // 배경 지도 (기존과 동일)
        const baseMap = new ol.layer.Tile({
            source: new ol.source.OSM()
        });
        
        // 대한민국 영역 정의 (기존과 동일)
        const koreaExtent4326 = [124.5, 33.0, 132.0, 38.8];
        const koreaExtent3857 = ol.proj.transformExtent(koreaExtent4326, 'EPSG:4326', 'EPSG:3857');

        // 지도 객체 생성
        const map = new ol.Map({
            target: 'map',
            layers: [baseMap, clusterLayer], // ◀◀◀ wmsLayer 대신 clusterLayer로 변경
            overlays: [overlay],
            view: new ol.View({
                center: ol.proj.fromLonLat([127.9, 36.5]),
                zoom: 7.5,
                extent: koreaExtent3857,
                minZoom: 7
            })
        });

        // 레이어 토글 기능
        const layerToggleCheckbox = document.getElementById('layer-toggle');
        layerToggleCheckbox.addEventListener('change', function() {
            clusterLayer.setVisible(this.checked); // ◀◀◀ clusterLayer로 변경
        });

        // 배경 지도 토글 기능 (기존과 동일)
        const basemapToggleCheckbox = document.getElementById('basemap-toggle');
        basemapToggleCheckbox.addEventListener('change', function() {
            baseMap.setVisible(this.checked);
        });

        // --- ⬇️ 5. 팝업 로직 수정 ⬇️ ---
        map.on('singleclick', function (evt) {
            // 클릭한 위치에 있는 피처(아이콘)를 찾음
            const feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                return feature;
            });
            
            overlay.setPosition(undefined); // 이전 팝업 닫기

            if (feature) {
                const coordinate = evt.coordinate;
                const originalFeatures = feature.get('features');
                const featureCount = originalFeatures.length;

                if (featureCount > 1) { // 클러스터를 클릭한 경우
                    let contentHtml = `<h4>${featureCount}개의 유산 정보</h4>`;
                    
                    originalFeatures.forEach(function(f, i) {
                        const props = f.getProperties();
                        // 💡 여기서 'l_kor_nm'은 실제 데이터의 문화유산 이름 컬럼명으로 변경해야 합니다.
                        contentHtml += `<h5>${i + 1}. ${props.l_kor_nm || '이름 없음'}</h5>`;
                    });

                    content.innerHTML = contentHtml;
                    overlay.setPosition(coordinate);

                } else if (featureCount === 1) { // 개별 아이콘을 클릭한 경우
                    const properties = originalFeatures[0].getProperties();
                    
                    let contentHtml = `<h4>속성 정보</h4><ul>`;
                    for (const key in properties) {
                        // geometry 정보는 팝업에 표시하지 않음
                        if (key !== 'geometry') {
                            contentHtml += `<li><b>${key}:</b> ${properties[key]}</li>`;
                        }
                    }
                    contentHtml += '</ul>';

                    content.innerHTML = contentHtml;
                    overlay.setPosition(coordinate);
                }
            }
        });
    </script>
</body>
</html>