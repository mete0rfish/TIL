# Heap Dump
- Java 애플리케이션을 운영하다 보면 메모리 누수(Memory Leak)나 비정상적인 메모리 사용량 증가와 같은 문제에 직면
- 이때 문제의 원인을 정확히 파악하기 위해 사용하는 강력한 도구가 바로 **힙 덤프(Heap Dump)**
- 힙 덤프는 **특정 시점의 JVM 힙 메모리 상태를 그대로 저장한 스냅샷 파일**로, 메모리 문제를 해결하는 데 결정적인 단서를 제공

## 힙 덤프란 무엇인가?
Java 애플리케이션의 모든 객체는 **힙(Heap)**이라는 메모리 영역에 생성되고 저장됩니다.
`힙 덤프`는 이 힙 영역의 전체적인 상태를 담은 파일(.hprof)입니다. 여기에는 다음과 같은 정보가 포함됩니다.

- **객체 정보**: 현재 힙에 존재하는 모든 객체의 클래스, 필드, 값.
- **객체 간의 참조 관계**: 어떤 객체가 다른 객체를 참조하고 있는지에 대한 정보.
- **스레드 정보**: 덤프 생성 시점의 스레드 스택 정보 및 로컬 변수.

이러한 정보를 통해 어떤 객체가 비정상적으로 많이 생성되었는지, 가비지 컬렉션(Garbage Collection)의 대상이 되어야 할 객체가 왜 메모리에서 해제되지 않고 남아있는지 등을 분석할 수 있습니다.

## 힙 덤프는 언제 사용해야 할까?

- **메모리 누수(Memory Leak) 발생 시**
    - 시간이 지남에 따라 애플리케이션의 메모리 사용량이 계속 증가하고, GC가 발생해도 메모리가 충분히 해제되지 않을 때 원인이 되는 객체를 찾기 위해 사용합니다.
    - OutOfMemoryError가 발생했다면 힙 덤프 분석이 필수적입니다.
- **성능 저하 문제 발생 시**
    - 잦은 Full GC 발생으로 인해 애플리케이션 응답 속도가 느려지는 경우, 
    - 힙 덤프를 통해 불필요하게 많은 메모리를 차지하는 객체를 파악하고 최적화할 수 있습니다.
- **애플리케이션 메모리 사용 현황 분석**
    - 현재 운영 중인 애플리케이션이 메모리를 어떻게 사용하고 있는지
    - 어떤 객체가 메모리의 대부분을 차지하는지 등을 파악하여 잠재적인 문제를 예방하고 싶을 때

## 힙 덤프는 어떻게 생성할까?

### 1. JVM 옵션 사용 (OutOfMemoryError 발생 시 자동 생성)
- 가장 권장되는 방법 중 하나
- `OutOfMemoryError`가 발생했을 때 자동으로 힙 덤프를 생성하도록 JVM 시작 옵션을 설정
- 문제 발생 시점의 정확한 메모리 상태를 포착

```Bash
java -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/path/to/dump/directory YourApplication
```
- `-XX:+HeapDumpOnOutOfMemoryError`
    - OutOfMemoryError 발생 시 힙 덤프를 생성
- `-XX:HeapDumpPath`
    - 힙 덤프 파일이 저장될 경로를 지정

### 2. jmap 명령어 사용 (실행 중인 애플리케이션)
- JDK에 포함된 jmap 명령어를 사용하면 실행 중인 Java 애플리케이션의 힙 덤프를 즉시 생성

```Bash
jmap -dump:format=b,file=heapdump.hprof <pid>
```
- `-dump:format=b,file=heapdump.hprof`
    - 바이너리 포맷으로 `heapdump.hprof`라는 이름의 덤프 파일을 생성
- `<pid>`
    - 힙 덤프를 생성할 Java 프로세스의 ID (Process ID) 입니다.
    - (jps 명령어로 확인 가능)

> **_WARNING:_** jmap을 실행하면 애플리케이션이 일시적으로 멈추는 'Stop-the-world' 현상이 발생하므로, 운영 환경에서는 주의해서 사용해야 합니다.


### 3. JVisualVM, JMC 등 GUI 도구 사용
`JVisualVM(Java VisualVM)`이나 `JMC(Java Mission Control)`와 같은 GUI 기반의 모니터링 도구를 사용하면 더욱 편리하게 힙 덤프를 생성

- JVisualVM
    - 대상 Java 프로세스에 연결한 후, 'Monitor' 탭에서 'Heap Dump' 버튼을 클릭하여 생성

이러한 도구들은 힙 덤프 생성뿐만 아니라 **실시간으로 CPU, 메모리 사용량 등을 모니터링**하는 기능도 제공하여 다각적인 분석을 가능하게 합니다.

## 힙 덤프 분석 방법
생성된 힙 덤프 파일(.hprof)은 **바이너리 파일**이므로 직접 내용을 확인하기 어렵습니다. 따라서 다음과 같은 분석 도구를 사용해야 합니다.

- **Eclipse MAT (Memory Analyzer Tool)**
    - 가장 강력하고 널리 사용되는 힙 덤프 분석 도구
    - 메모리 누수 의심 객체를 자동으로 찾아주는 'Leak Suspects' 리포트 기능이 매우 유용
    - 특정 객체를 기준으로 참조 관계(Dominator Tree, Path to GC Roots)를 분석하여 메모리가 해제되지 않는 원인을 쉽게 파악

- **JVisualVM**
    - 힙 덤프 생성뿐만 아니라 기본적인 분석 기능도 제공
    - 클래스별 인스턴스 수, 점유 메모리 크기 등을 확인 가능
